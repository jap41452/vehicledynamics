<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Vehicle Geometry Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"
  }
}
</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:#eaeaea; }
  #container { display:flex; height:100vh; }
  #ui { width:300px; padding:10px; background:#fff; border-right:1px solid #ccc; box-sizing:border-box; overflow-y:auto; }
  #viewer { flex:1; position:relative; }

  h2{font-size:14px;margin:0 0 8px 0;}
  h3{font-size:12px;margin:10px 0 4px 0;border-bottom:1px solid #ddd;}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:6px 8px;}
  label{font-size:11px;}
  input[type="number"], select{width:100%;padding:4px;font-size:11px;box-sizing:border-box;}
  .units{float:right;font-size:10px;color:#777;}
  button{width:100%;margin-top:6px;padding:6px;font-size:12px;cursor:pointer;}

  details { margin-top:8px; }
  summary { font-size:12px; font-weight:600; cursor:pointer; }
  .feature-row { font-size:11px; margin:6px 0; }
  .feature-row button { width:auto; margin-left:6px; padding:2px 6px; font-size:10px; }
</style>
</head>

<body>
<div id="container">

<div id="ui">
  <h2>Vehicle Geometry</h2>

  <h3>Box 1</h3>
  <div class="grid2">
    <label>Length (Y)<input id="box1_L" type="number" value="120"></label>
    <label>Width (X)<input id="box1_W" type="number" value="72"></label>
    <label>Height (Z)<input id="box1_H" type="number" value="24"></label>
    <label>Weight<input id="box1_Wt" type="number" value="2500"></label>
  </div>

  <h3>Box 2</h3>
  <div class="grid2">
    <label>Length (Y)<input id="box2_L" type="number" value="60"></label>
    <label>Width (X)<input id="box2_W" type="number" value="60"></label>
    <label>Height (Z)<input id="box2_H" type="number" value="20"></label>
    <label>Weight<input id="box2_Wt" type="number" value="800"></label>
    <label>Front Offset (Y)<input id="box2_dY" type="number" value="0"></label>
  </div>

  <h3>Wheels</h3>
  <div class="grid2">
    <label>Diameter<input id="wheel_D" type="number" value="32"></label>
    <label>Weight<input id="wheel_Wt" type="number" value="120"></label>
    <label>Front Y<input id="wheel_Yf" type="number" value="-20"></label>
    <label>Rear Spacing<input id="wheel_dYr" type="number" value="80"></label>
  </div>

  <button id="updateBtn">Update Vehicle</button>

  <h3>Road Features</h3>
  <button id="addBumpBtn">Add Speed Bump</button>
  <button id="addPotholeBtn">Add Pothole</button>

  <details open>
    <summary>Existing Features</summary>
    <div id="featureList"></div>
  </details>
</div>

<div id="viewer"></div>
</div>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js';

let scene, camera, renderer, controls;
let vehicleGroup = new THREE.Group();
let groundGroup = new THREE.Group();
let roadFeatures = [];
let nextFeatureId = 1;

init();
buildVehicle();

/* ---------- INIT ---------- */
function init() {
  THREE.Object3D.DEFAULT_UP.set(0,0,1);

  scene = new THREE.Scene();
  scene.background = new THREE.Color(0xf0f0f0);

  camera = new THREE.PerspectiveCamera(45,1,0.1,5000);
  camera.position.set(300,-500,300);

  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(viewer.clientWidth,viewer.clientHeight);
  viewer.appendChild(renderer.domElement);

  controls = new OrbitControls(camera,renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.08;

  window.addEventListener('resize',()=> {
    camera.aspect = viewer.clientWidth/viewer.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(viewer.clientWidth,viewer.clientHeight);
  });

  scene.add(new THREE.AmbientLight(0xffffff,0.6));
  const dl = new THREE.DirectionalLight(0xffffff,0.8);
  dl.position.set(200,-200,400);
  scene.add(dl);

  scene.add(vehicleGroup);
  scene.add(groundGroup);

  const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(600,600,20,20),
    new THREE.MeshStandardMaterial({color:0xcccccc,side:THREE.DoubleSide,depthWrite:false})
  );
  ground.position.z = -0.5;
  groundGroup.add(ground);

  animate();
}

/* ---------- VEHICLE ---------- */
function buildVehicle() {
  vehicleGroup.clear();

  const L = +box1_L.value;
  const W = +box1_W.value;
  const H = +box1_H.value;
  const R = +wheel_D.value/2;

  const box1 = new THREE.Mesh(
    new THREE.BoxGeometry(W,L,H),
    new THREE.MeshStandardMaterial({color:0x555555})
  );
  box1.position.set(0,-L/2,H/2+R);
  vehicleGroup.add(box1);

  const box2 = new THREE.Mesh(
    new THREE.BoxGeometry(+box2_W.value,+box2_L.value,+box2_H.value),
    new THREE.MeshStandardMaterial({color:0xaaaaaa})
  );
  box2.position.set(0,+box2_dY.value - box2_L.value/2,H + box2_H.value/2 + R);
  vehicleGroup.add(box2);

  const wheelGeom = new THREE.CylinderGeometry(R,R,4,32);
  const wheelMat = new THREE.MeshStandardMaterial({color:0x000000});
  const yRear = +wheel_Yf.value - +wheel_dYr.value;
  const xOff = W/2;

  [[-xOff,wheel_Yf.value],[xOff,wheel_Yf.value],[-xOff,yRear],[xOff,yRear]].forEach(([x,y])=>{
    const w = new THREE.Mesh(wheelGeom,wheelMat);
    w.rotation.z = Math.PI/2;
    w.position.set(x,y,R);
    vehicleGroup.add(w);
  });

  groundGroup.position.set(0,-L/2,0);
  controls.target.set(0,-L/2,H);
  controls.update();
}

/* ---------- ROAD FEATURE BUILDER (CANONICAL) ---------- */
function buildProfileFeature({ profileYZ, widthX, centerX, startY, material }) {
  const shape = new THREE.Shape();
  shape.moveTo(profileYZ[0][0], profileYZ[0][1]);
  for (let i=1;i<profileYZ.length;i++) {
    shape.lineTo(profileYZ[i][0], profileYZ[i][1]);
  }

  const geom = new THREE.ExtrudeGeometry(shape, {
    depth: widthX,
    bevelEnabled:false
  });

  // Center extrusion about X = 0
  geom.translate(0,0,-widthX/2);

  // Place so leading edge starts at requested Y
  geom.translate(0,startY,0);

  return new THREE.Mesh(geom, material);
}

/* ---------- SPEED BUMP ---------- */
addBumpBtn.onclick = ()=> {
  Swal.fire({
    title:'Add Speed Bump',
    html:`
      <label>Height<input id="bH" type="number" value="3"></label><br>
      <label>Width Y<input id="bW" type="number" value="24"></label><br>
      <label>Start distance from front<input id="bY" type="number" value="60"></label>
    `,
    preConfirm:()=>({ h:+bH.value, w:+bW.value, y:+bY.value })
  }).then(r=>r.value && addSpeedBump(r.value));
};

function addSpeedBump({h,w,y}) {
  const L = +box1_L.value;
  const W = +box1_W.value;
  const r = w/2;

  const pts = [];
  for (let i=0;i<=24;i++) {
    const t = Math.PI*i/24;
    pts.push([ r*(t/Math.PI*2 -1), h*Math.sin(t) ]);
  }

  const mesh = buildProfileFeature({
    profileYZ: pts,
    widthX: W,
    centerX: 0,
    startY: y + L/2,
    material: new THREE.MeshStandardMaterial({color:0x888888})
  });

  addFeature('Speed Bump', {h,w,y}, mesh);
}

/* ---------- POTHOLE ---------- */
addPotholeBtn.onclick = ()=> {
  Swal.fire({
    title:'Add Pothole',
    html:`
      <label>Depth<input id="pD" type="number" value="2"></label><br>
      <label>Length Y<input id="pL" type="number" value="18"></label><br>
      <label>Start distance from front<input id="pY" type="number" value="48"></label><br>
      <label>Side
        <select id="pS">
          <option>Left</option>
          <option>Right</option>
          <option>Both</option>
        </select>
      </label>
    `,
    preConfirm:()=>({ d:+pD.value, l:+pL.value, y:+pY.value, s:pS.value })
  }).then(r=>r.value && addPothole(r.value));
};

function addPothole({d,l,y,s}) {
  const L = +box1_L.value;
  const W = +box1_W.value;
  const track = W/2;
  const xs = s==='Both' ? [-track,track] : [s==='Left'?-track:track];

  xs.forEach(x=>{
    const mesh = buildProfileFeature({
      profileYZ: [[0,0],[l/2,-d],[l,0]],
      widthX: 12,
      centerX: x,
      startY: y + L/2,
      material: new THREE.MeshStandardMaterial({color:0x666666,side:THREE.DoubleSide})
    });
    mesh.position.x = x;
    addFeature(`Pothole (${s})`, {d,l,y,s}, mesh);
  });
}

/* ---------- FEATURE MANAGEMENT ---------- */
function addFeature(type, params, mesh) {
  mesh.userData.id = nextFeatureId;
  groundGroup.add(mesh);
  roadFeatures.push({ id: nextFeatureId, type, params, mesh });
  nextFeatureId++;
  refreshFeatureList();
}

function refreshFeatureList() {
  featureList.innerHTML = '';
  roadFeatures.forEach(f=>{
    const div = document.createElement('div');
    div.className = 'feature-row';
    div.innerHTML = `(${f.id}) ${f.type}
      <button onclick="deleteFeature(${f.id})">Delete</button>`;
    featureList.appendChild(div);
  });
}

window.deleteFeature = id => {
  const i = roadFeatures.findIndex(f=>f.id===id);
  if (i>=0) {
    groundGroup.remove(roadFeatures[i].mesh);
    roadFeatures.splice(i,1);
    refreshFeatureList();
  }
};

function animate(){
  requestAnimationFrame(animate);
  renderer.render(scene,camera);
}

updateBtn.onclick = buildVehicle;
</script>

</body>
</html>










