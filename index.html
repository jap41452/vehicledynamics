<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Vehicle Geometry Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"
  }
}
</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body { margin:0; font-family:system-ui; background:#eaeaea; }
#container { display:flex; height:100vh; }
#ui { width:300px; padding:10px; background:#fff; border-right:1px solid #ccc; overflow-y:auto; }
#viewer { flex:1; }
h2{font-size:14px;margin:0 0 8px;}
h3{font-size:12px;margin:10px 0 4px;border-bottom:1px solid #ddd;}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:6px 8px;}
label{font-size:11px;}
input{width:100%;padding:4px;font-size:11px;}
button{width:100%;margin-top:8px;padding:6px;font-size:12px;}
.readout{font-size:11px;background:#fafafa;border:1px solid #ddd;padding:6px;border-radius:6px;}
.row{display:flex;justify-content:space-between;}
</style>
</head>

<body>
<div id="container">
<div id="ui">

<h2>Vehicle Geometry</h2>

<h3>Box 1</h3>
<div class="grid2">
<label>Length<input id="box1_L" type="number" value="120"></label>
<label>Width<input id="box1_W" type="number" value="72"></label>
<label>Height<input id="box1_H" type="number" value="24"></label>
<label>Weight<input id="box1_Wt" type="number" value="2500"></label>
</div>

<h3>Box 2</h3>
<div class="grid2">
<label>Length<input id="box2_L" type="number" value="60"></label>
<label>Width<input id="box2_W" type="number" value="60"></label>
<label>Height<input id="box2_H" type="number" value="20"></label>
<label>Weight<input id="box2_Wt" type="number" value="800"></label>
<label>Front Offset<input id="box2_dY" type="number" value="0"></label>
</div>

<h3>Wheels</h3>
<div class="grid2">
<label>Diameter<input id="wheel_D" type="number" value="32"></label>
<label>Weight<input id="wheel_Wt" type="number" value="120"></label>
<label>Front Y<input id="wheel_Yf" type="number" value="-20"></label>
<label>Rear Spacing<input id="wheel_dYr" type="number" value="80"></label>
</div>

<h3>Suspension</h3>
<div class="grid2">
<label>Front k<input id="k_sf" type="number" value="300"></label>
<label>Front c<input id="c_sf" type="number" value="25"></label>
<label>Rear k<input id="k_sr" type="number" value="350"></label>
<label>Rear c<input id="c_sr" type="number" value="30"></label>
</div>

<h3>Tires</h3>
<div class="grid2">
<label>Front k<input id="k_tf" type="number" value="1200"></label>
<label>Rear k<input id="k_tr" type="number" value="1400"></label>
</div>

<h3>Simulation</h3>
<div class="grid2">
<label>Speed<input id="veh_v" type="number" value="120"></label>
<label>Gravity<input id="veh_g" type="number" value="386.09"></label>
</div>

<button id="updateBtn">Update Vehicle</button>

<h3>Road</h3>
<button id="addBumpBtn">Add Speed Bump</button>
<button id="addHalfBumpBtn">Add 1/2 Speed Bump</button>
<div id="featureList"></div>

</div>
<div id="viewer"></div>
</div>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js';

/* =================== CORE DATA =================== */

let scene, camera, renderer, controls;
let vehicleGroup = new THREE.Group();
let groundGroup  = new THREE.Group();
let roadFeatures = [];

const state = {
  z:0, phi:0, theta:0,
  dz:0, dphi:0, dtheta:0,
  zw:{FL:0,FR:0,RL:0,RR:0},
  dzw:{FL:0,FR:0,RL:0,RR:0}
};

/* =================== INITIALIZATION =================== */

init();
buildVehicle();

/* =================== THREE =================== */

function init(){
  THREE.Object3D.DEFAULT_UP.set(0,0,1);
  scene=new THREE.Scene();
  scene.background=new THREE.Color(0xf0f0f0);

  camera=new THREE.PerspectiveCamera(45,1,0.1,5000);
  camera.position.set(300,-500,300);

  renderer=new THREE.WebGLRenderer({antialias:true});
  viewer.appendChild(renderer.domElement);

  controls=new OrbitControls(camera,renderer.domElement);
  controls.enableDamping=true;

  scene.add(new THREE.AmbientLight(0xffffff,0.6));
  const dl=new THREE.DirectionalLight(0xffffff,0.8);
  dl.position.set(200,-200,400);
  scene.add(dl);

  scene.add(vehicleGroup);
  scene.add(groundGroup);

  animate();
}

function animate(){
  requestAnimationFrame(animate);
  renderer.setSize(viewer.clientWidth,viewer.clientHeight);
  camera.aspect=viewer.clientWidth/viewer.clientHeight;
  camera.updateProjectionMatrix();
  renderer.render(scene,camera);
}

/* =================== VEHICLE BUILD =================== */

function buildVehicle(){
  vehicleGroup.clear();
  groundGroup.clear();

  const L1=+box1_L.value, W1=+box1_W.value, H1=+box1_H.value;
  const R=+wheel_D.value/2;

  const box1=new THREE.Mesh(
    new THREE.BoxGeometry(W1,L1,H1),
    new THREE.MeshStandardMaterial({color:0x555555})
  );
  box1.position.set(0,-L1/2,H1/2+R);
  vehicleGroup.add(box1);

  computeMassProps(box1);
  computeWheelOffsets();
  initStaticEquilibrium(state);
}

/* =================== MASS PROPS =================== */

function computeMassProps(box){
  const g=386.09;
  const M=(+box1_Wt.value)/g;
  window.massProps={
    M,
    CG:{x:0,y:box.position.y,z:box.position.z},
    I:{Ixx:M*1000,Iyy:M*1000}
  };
}

/* =================== WHEELS =================== */

function computeWheelOffsets(){
  const W=+box1_W.value;
  const yF=+wheel_Yf.value;
  const yR=yF-+wheel_dYr.value;
  window.wheelOffsets=[
    {name:'FL',x:-W/2,y:yF},
    {name:'FR',x: W/2,y:yF},
    {name:'RL',x:-W/2,y:yR},
    {name:'RR',x: W/2,y:yR}
  ];
}

/* =================== ROAD =================== */

function roadHeightAt(x,y){
  let z=0;
  for(const f of roadFeatures){
    if(f.type==='bump') z=Math.max(z,evalBump(f.params,y));
  }
  return z;
}

function evalBump(p,y){
  const r=p.w/2;
  const dy=y-p.y;
  if(Math.abs(dy)>r) return 0;
  return p.h*Math.sqrt(1-(dy*dy)/(r*r));
}

/* =================== STATICS =================== */

function bodyZatWheel(state,name){
  const w=wheelOffsets.find(o=>o.name===name);
  return state.z-state.phi*w.x+state.theta*w.y;
}

function initStaticEquilibrium(state){
  const g=+veh_g.value;
  const ksF=+k_sf.value, ksR=+k_sr.value;
  const ktF=+k_tf.value, ktR=+k_tr.value;
  const mw=(+wheel_Wt.value)/g;

  let z=10;
  for(let i=0;i<20;i++){
    let sum=0;
    for(const n of ['FL','FR','RL','RR']){
      const isF=n[0]==='F';
      const ks=isF?ksF:ksR;
      const kt=isF?ktF:ktR;
      const zb=z;
      const zw=(mw*g-ks*zb)/(kt-ks);
      sum+=ks*(zb-zw);
      state.zw[n]=zw;
    }
    z+=(sum-window.massProps.M*g)/(ksF*2+ksR*2);
  }
  state.z=z;
}

/* =================== UI =================== */

updateBtn.onclick=buildVehicle;

</script>
</body>
</html>





















